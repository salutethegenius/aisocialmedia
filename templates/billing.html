{% extends "base.html" %}

{% block content %}
<h2>Billing Information</h2>

<h3>Project Summary:</h3>
<p><strong>Total Tokens Used:</strong> {{ total_credits }}</p>
<p><strong>Total Cost:</strong> ${{ "%.2f"|format(project_cost) }}</p>

<button id="checkout-button">Proceed to Checkout</button>
<div id="loading" style="display: none;">Processing...</div>
<div id="error-message" style="color: red;"></div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var stripe = Stripe('{{ STRIPE_PUBLISHABLE_KEY }}');
        var checkoutButton = document.getElementById('checkout-button');
        var loadingIndicator = document.getElementById('loading');
        var errorMessage = document.getElementById('error-message');

        checkoutButton.addEventListener('click', function() {
            loadingIndicator.style.display = 'block';
            errorMessage.textContent = '';

            fetch('/billing', {
                method: 'POST',
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(function(session) {
                return stripe.redirectToCheckout({ sessionId: session.id });
            })
            .then(function(result) {
                if (result.error) {
                    throw new Error(result.error.message);
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                errorMessage.textContent = 'An error occurred: ' + error.message;
            })
            .finally(function() {
                loadingIndicator.style.display = 'none';
            });
        });
    });
</script>
{% endblock %}
